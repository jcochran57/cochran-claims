<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cochran Insurance Claims Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .company-logo {
            font-size: 42px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .company-tagline {
            color: #666;
            font-size: 16px;
        }

        /* Main Screens Container */
        .screen {
            display: none;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .screen.active {
            display: block;
        }

        /* Home Screen */
        .home-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .home-btn {
            padding: 40px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }

        .home-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
        }

        .home-btn:active {
            transform: translateY(-1px);
        }

        .btn-icon {
            font-size: 48px;
            display: block;
            margin-bottom: 15px;
        }

        .btn-label {
            font-size: 20px;
            display: block;
        }

        .btn-desc {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 8px;
            font-weight: 400;
        }

        /* Forms */
        .form-section {
            margin-bottom: 35px;
        }

        .form-section-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input, select, textarea {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Buttons */
        .button-row {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* Search/Open Screen */
        .search-box {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .search-box input {
            flex: 1;
        }

        .claims-list {
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .claim-item {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .claim-item:hover {
            background: #f9f9f9;
        }

        .claim-item:last-child {
            border-bottom: none;
        }

        .claim-name {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .claim-details {
            font-size: 14px;
            color: #666;
        }

        .claim-date {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .no-claims {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-size: 16px;
        }

        /* Status Messages */
        .status-message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            display: none;
        }

        .status-message.show {
            display: block;
        }

        .status-message.success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }

        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }

        /* Current Claim Info Bar */
        .current-claim-bar {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .current-claim-bar.show {
            display: flex;
        }

        .current-claim-info {
            font-weight: 600;
        }

        .current-claim-name {
            font-size: 18px;
            margin-bottom: 3px;
        }

        .current-claim-date {
            font-size: 13px;
            opacity: 0.9;
        }

        /* Property Estimator Iframe */
        #property-estimator-frame {
            width: 100%;
            height: calc(100vh - 100px);
            border: none;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        /* Responsive - Enhanced for iPad & iPhone */
        @media (max-width: 768px) {
            body {
                font-size: 16px; /* Prevent zoom on input focus iOS */
            }

            .container {
                padding: 10px;
            }

            .header {
                padding: 15px;
                margin-bottom: 15px;
            }

            .company-logo {
                font-size: 26px;
            }

            .company-tagline {
                font-size: 13px;
            }

            .screen {
                padding: 15px;
            }

            /* Larger touch targets for mobile - iOS recommends 44px minimum */
            .home-btn {
                min-height: 100px;
                padding: 20px;
                margin-bottom: 15px;
            }

            .btn-icon {
                font-size: 36px;
                margin-bottom: 8px;
            }

            .btn-label {
                font-size: 18px;
                margin-bottom: 4px;
            }

            .btn-desc {
                font-size: 13px;
            }

            .home-buttons {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            /* Forms optimized for mobile */
            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; /* Prevents iOS zoom */
                padding: 12px;
                min-height: 44px; /* iOS touch target */
            }

            /* Buttons stack vertically on mobile */
            .button-row {
                flex-direction: column;
                gap: 10px;
            }

            .btn {
                width: 100%;
                min-height: 48px;
                font-size: 16px;
                padding: 12px 20px;
            }

            /* Current claim bar mobile */
            .current-claim-bar {
                flex-direction: column;
                gap: 10px;
                padding: 12px;
            }

            .current-claim-info {
                text-align: center;
            }

            .current-claim-name {
                font-size: 16px;
            }

            /* Tabs mobile - horizontal scroll */
            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                gap: 8px;
            }

            .tab {
                min-width: 110px;
                padding: 12px 16px;
                font-size: 14px;
                flex-shrink: 0;
            }

            /* Import/Fetch screens mobile */
            #importDataField {
                font-size: 14px;
                padding: 10px;
                min-height: 250px;
            }

            #webAppUrl {
                font-size: 14px;
                padding: 12px;
            }

            /* Submission cards mobile */
            #submissionsList > div {
                padding: 15px;
                margin-bottom: 12px;
            }

            /* Status messages mobile */
            .status-message {
                font-size: 14px;
                padding: 12px;
                margin-bottom: 15px;
            }

            /* Search and lists mobile */
            #claimSearch {
                font-size: 16px;
                padding: 12px;
            }

            .claim-item {
                padding: 15px;
                margin-bottom: 10px;
            }

            /* Headings mobile */
            h1 {
                font-size: 24px !important;
            }

            h2 {
                font-size: 20px;
            }

            h3 {
                font-size: 17px;
            }

            /* Form sections mobile */
            .form-section {
                padding: 15px;
                margin-bottom: 15px;
            }
        }

        /* iPhone specific (smaller screens) */
        @media (max-width: 430px) {
            .company-logo {
                font-size: 22px;
            }

            .company-tagline {
                font-size: 12px;
            }

            .home-btn {
                min-height: 85px;
                padding: 15px;
            }

            .btn-icon {
                font-size: 30px;
            }

            .btn-label {
                font-size: 16px;
            }

            .btn-desc {
                font-size: 12px;
            }

            h1 {
                font-size: 20px !important;
            }

            h2 {
                font-size: 18px;
            }

            h3 {
                font-size: 15px;
            }

            .tab {
                min-width: 95px;
                padding: 10px 12px;
                font-size: 13px;
            }

            .btn {
                font-size: 15px;
                padding: 10px 16px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 10px;
            }
        }

        /* iPad landscape (1024px and below) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 900px;
                padding: 20px;
            }

            .home-buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }

            .form-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }

            .home-btn {
                min-height: 110px;
            }
        }

        /* iPad portrait (768-834px) */
        @media (min-width: 768px) and (max-width: 834px) and (orientation: portrait) {
            .container {
                max-width: 700px;
            }

            .home-buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .btn {
                font-size: 16px;
            }

            .home-btn {
                min-height: 105px;
            }
        }

        /* Ensure all interactive elements have proper touch targets */
        button, a, input[type="submit"], input[type="button"], select {
            min-height: 44px;
            min-width: 44px;
        }

        /* Prevent zoom on input focus (iOS) */
        input, select, textarea {
            font-size: 16px !important;
        }

        /* Smooth scrolling */
        * {
            -webkit-overflow-scrolling: touch;
        }

        /* Prevent double-tap zoom */
        * {
            touch-action: manipulation;
        }

        /* Remove iOS input shadows */
        input, textarea, select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }


        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="company-logo">üè† COCHRAN CLAIMS</div>
            <div class="company-tagline">Professional Insurance Claims Management</div>
        </div>

        <!-- Current Claim Info Bar -->
        <div class="current-claim-bar" id="currentClaimBar">
            <div class="current-claim-info">
                <div class="current-claim-name" id="currentClaimName">No Claim Loaded</div>
                <div class="current-claim-date" id="currentClaimDate"></div>
            </div>
            <button class="btn btn-secondary" onclick="claimManager.returnHome()">‚Üê Back to Home</button>
        </div>

        <!-- Status Message -->
        <div class="status-message" id="statusMessage"></div>

        <!-- HOME SCREEN -->
        <div class="screen active" id="homeScreen">
            <h1 style="text-align: center; margin-bottom: 40px; color: #333;">Claim Management</h1>
            <div class="home-buttons">
                <button class="home-btn" onclick="claimManager.newClaim()">
                    <span class="btn-icon">üìù</span>
                    <span class="btn-label">NEW</span>
                    <span class="btn-desc">Start a new claim</span>
                </button>
                <button class="home-btn" onclick="claimManager.showOpenScreen()">
                    <span class="btn-icon">üìÇ</span>
                    <span class="btn-label">OPEN</span>
                    <span class="btn-desc">Open existing claim</span>
                </button>
                <button class="home-btn" onclick="claimManager.showFetchScreen()">
                    <span class="btn-icon">üîÑ</span>
                    <span class="btn-label">FETCH NEW</span>
                    <span class="btn-desc">Get new form submissions</span>
                </button>
                <button class="home-btn" onclick="claimManager.showImportScreen()">
                    <span class="btn-icon">üì•</span>
                    <span class="btn-label">IMPORT</span>
                    <span class="btn-desc">Import from clipboard</span>
                </button>
                <button class="home-btn" onclick="claimManager.saveClaim()" id="homeSaveBtn" style="opacity: 0.5;" disabled>
                    <span class="btn-icon">üíæ</span>
                    <span class="btn-label">SAVE</span>
                    <span class="btn-desc">Save current claim</span>
                </button>
                <button class="home-btn" onclick="claimManager.showSaveAsScreen()" id="homeSaveAsBtn" style="opacity: 0.5;" disabled>
                    <span class="btn-icon">üì§</span>
                    <span class="btn-label">SAVE AS</span>
                    <span class="btn-desc">Save with new name</span>
                </button>
            </div>
        </div>

        <!-- OPEN SCREEN -->
        <div class="screen" id="openScreen">
            <h2 style="margin-bottom: 30px;">Open Existing Claim</h2>
            
            <div class="search-box">
                <input type="text" id="searchLastName" placeholder="Last Name" oninput="claimManager.searchClaims()">
                <input type="text" id="searchFirstName" placeholder="First Name" oninput="claimManager.searchClaims()">
                <button class="btn btn-primary" onclick="claimManager.searchClaims()">üîç Search</button>
            </div>

            <div class="claims-list" id="claimsList">
                <div class="no-claims">No claims found. Create a new claim to get started.</div>
            </div>

            <div class="button-row">
                <button class="btn btn-secondary" onclick="claimManager.showScreen('homeScreen')">Cancel</button>
            </div>
        </div>

        <!-- IMPORT SCREEN -->
        <div class="screen" id="importScreen">
            <h2 style="margin-bottom: 20px;">üì• Import Claim Data</h2>
            
            <p style="color: #666; margin-bottom: 25px; line-height: 1.6;">
                Paste data from <strong>Google Forms</strong>, <strong>Google Sheets</strong>, or any spreadsheet. 
                The system will automatically detect the format and populate all fields.
            </p>

            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; color: #555; font-size: 16px;">üìã Supported Formats:</h3>
                <ul style="margin: 0; padding-left: 20px; color: #666; line-height: 1.8;">
                    <li><strong>JSON</strong> - Export from Google Sheets as JSON</li>
                    <li><strong>CSV</strong> - Copy from Google Sheets or Excel</li>
                    <li><strong>Tab-separated</strong> - Copy directly from spreadsheet</li>
                    <li><strong>Plain text</strong> - Any format with labels and values</li>
                </ul>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #555;">
                    Paste Your Data Here:
                </label>
                <textarea id="importDataField" 
                          style="width: 100%; min-height: 300px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; resize: vertical;"
                          placeholder="Paste data here...

Examples:

JSON Format:
{&quot;firstName&quot;: &quot;John&quot;, &quot;lastName&quot;: &quot;Smith&quot;, &quot;address&quot;: &quot;123 Main St&quot;...}

CSV Format:
firstName,lastName,address,city,state,zip
John,Smith,123 Main St,Dallas,TX,75001

Tab-separated (from spreadsheet):
First Name    John
Last Name     Smith
Address       123 Main St

Plain text:
First Name: John
Last Name: Smith
Address: 123 Main St"></textarea>
            </div>

            <div id="importPreview" style="display: none; background: #e8f5e9; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
                <h3 style="margin: 0 0 15px 0; color: #2e7d32;">‚úÖ Data Detected!</h3>
                <div id="importPreviewContent" style="font-size: 14px; color: #555; line-height: 1.6;"></div>
            </div>

            <div id="importError" style="display: none; background: #ffebee; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #f44336;">
                <h3 style="margin: 0 0 10px 0; color: #c62828;">‚ùå Could Not Parse Data</h3>
                <div id="importErrorMessage" style="font-size: 14px; color: #666; line-height: 1.6;"></div>
            </div>

            <div class="button-row">
                <button class="btn btn-secondary" onclick="claimManager.showScreen('homeScreen')">Cancel</button>
                <button class="btn btn-primary" onclick="claimManager.previewImport()">üëÄ Preview Data</button>
                <button class="btn btn-success" onclick="claimManager.importClaim()" id="importConfirmBtn" style="display: none;">‚úÖ Import Claim</button>
            </div>
        </div>

        <!-- FETCH NEW SUBMISSIONS SCREEN -->
        <div class="screen" id="fetchScreen">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                <h2 style="margin: 0;">üîÑ Fetch New Submissions</h2>
                <button onclick="claimManager.resetWebAppUrl()" 
                        style="background: #ff9800; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: all 0.3s; min-height: 44px;"
                        onmouseover="this.style.background='#f57c00'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" 
                        onmouseout="this.style.background='#ff9800'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)'">
                    üîÑ Reset URL
                </button>
            </div>
            
            <p style="color: #666; margin-bottom: 25px; line-height: 1.6;">
                Connect to your Google Form to automatically fetch new submissions. No more copy/paste!
            </p>

            <!-- Settings Section -->
            <div id="fetchSettings" style="background: #fff8dc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ff9800;">
                <h3 style="margin: 0 0 15px 0; color: #e65100;">‚öôÔ∏è Setup Required</h3>
                <p style="margin: 0 0 15px 0; color: #666; line-height: 1.6;">
                    To use auto-fetch, you need to set up your Google Apps Script Web App URL.
                </p>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">
                        Web App URL:
                    </label>
                    <input type="text" id="webAppUrl" 
                           style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: monospace; font-size: 12px;"
                           placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="claimManager.saveWebAppUrl()">üíæ Save URL</button>
                    <button class="btn btn-secondary" onclick="claimManager.showSetupInstructions()">üìñ Setup Instructions</button>
                </div>
            </div>

            <!-- Submissions List -->
            <div id="fetchSubmissions" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #555;">üìã New Submissions</h3>
                    <div>
                        <label style="margin-right: 10px;">
                            <input type="checkbox" id="showAllSubmissions" onchange="claimManager.fetchSubmissions()">
                            Show all (including imported)
                        </label>
                    </div>
                </div>

                <div id="submissionsList" style="max-height: 500px; overflow-y: auto;">
                    <!-- Submissions will be populated here -->
                </div>
            </div>

            <div id="fetchLoading" style="display: none; text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
                <div style="font-size: 18px;">Fetching submissions...</div>
            </div>

            <div id="fetchError" style="display: none; background: #ffebee; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #f44336;">
                <h3 style="margin: 0 0 10px 0; color: #c62828;">‚ùå Error</h3>
                <div id="fetchErrorMessage" style="font-size: 14px; color: #666; line-height: 1.6;"></div>
            </div>

            <div class="button-row">
                <button class="btn btn-secondary" onclick="claimManager.showScreen('homeScreen')">‚Üê Back</button>
                <button class="btn btn-primary" onclick="claimManager.fetchSubmissions()" id="fetchBtn" style="display: none;">üîÑ Fetch Submissions</button>
            </div>
        </div>

        <!-- CLIENT INFO SCREEN -->
        <div class="screen" id="clientScreen">
            <h2 style="margin-bottom: 30px;">Client Information</h2>

            <form id="clientForm">
                <div class="form-section">
                    <div class="form-section-title">Personal Information</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>First Name *</label>
                            <input type="text" name="firstName" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name *</label>
                            <input type="text" name="lastName" required>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" name="phone" placeholder="(555) 123-4567">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" name="email" placeholder="client@example.com">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">Property Address</div>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Street Address *</label>
                            <input type="text" name="address" required>
                        </div>
                        <div class="form-group">
                            <label>City *</label>
                            <input type="text" name="city" required>
                        </div>
                        <div class="form-group">
                            <label>State *</label>
                            <input type="text" name="state" required>
                        </div>
                        <div class="form-group">
                            <label>ZIP Code *</label>
                            <input type="text" name="zip" required>
                        </div>
                    </div>
                </div>

                <div class="button-row">
                    <button type="button" class="btn btn-secondary" onclick="claimManager.showScreen('homeScreen')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Next: Claim Info ‚Üí</button>
                </div>
            </form>
        </div>

        <!-- CLAIM INFO SCREEN -->
        <div class="screen" id="claimScreen">
            <h2 style="margin-bottom: 30px;">Claim Information</h2>

            <form id="claimForm">
                <div class="form-section">
                    <div class="form-section-title">Claim Details</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Claim Number *</label>
                            <input type="text" name="claimNumber" required>
                        </div>
                        <div class="form-group">
                            <label>Date of Loss *</label>
                            <input type="date" name="dateOfLoss" required>
                        </div>
                        <div class="form-group full-width">
                            <label>Loss Type *</label>
                            <select name="lossType" required>
                                <option value="">Select loss type...</option>
                                <option value="Water Damage">Water Damage</option>
                                <option value="Fire">Fire</option>
                                <option value="Storm">Storm</option>
                                <option value="Wind">Wind</option>
                                <option value="Hail">Hail</option>
                                <option value="Theft">Theft</option>
                                <option value="Vandalism">Vandalism</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label>Description of Loss</label>
                            <textarea name="description" placeholder="Describe the damage and circumstances..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="button-row">
                    <button type="button" class="btn btn-secondary" onclick="claimManager.showScreen('clientScreen')">‚Üê Back</button>
                    <button type="submit" class="btn btn-primary">Next: Insurance Info ‚Üí</button>
                </div>
            </form>
        </div>

        <!-- INSURANCE INFO SCREEN -->
        <div class="screen" id="insuranceScreen">
            <h2 style="margin-bottom: 30px;">Insurance Information</h2>

            <form id="insuranceForm">
                <div class="form-section">
                    <div class="form-section-title">Insurance Company</div>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Insurance Company *</label>
                            <input type="text" name="company" required>
                        </div>
                        <div class="form-group full-width">
                            <label>Policy Number *</label>
                            <input type="text" name="policyNumber" required>
                        </div>
                        <div class="form-group">
                            <label>Deductible</label>
                            <input type="text" name="deductible" placeholder="$1,000">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">Adjuster Information</div>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Adjuster Name</label>
                            <input type="text" name="adjuster">
                        </div>
                        <div class="form-group">
                            <label>Adjuster Phone</label>
                            <input type="tel" name="adjusterPhone" placeholder="(555) 123-4567">
                        </div>
                        <div class="form-group">
                            <label>Adjuster Email</label>
                            <input type="email" name="adjusterEmail">
                        </div>
                    </div>
                </div>

                <div class="button-row">
                    <button type="button" class="btn btn-secondary" onclick="claimManager.showScreen('claimScreen')">‚Üê Back</button>
                    <button type="submit" class="btn btn-success">Open Property Estimator ‚Üí</button>
                </div>
            </form>
        </div>

        <!-- SAVE AS SCREEN -->
        <div class="screen" id="saveAsScreen">
            <h2 style="margin-bottom: 30px;">Save Claim As...</h2>

            <div class="form-section">
                <div class="form-group">
                    <label>Claim Name</label>
                    <input type="text" id="saveAsName" placeholder="LastName-FirstName-ClaimNumber">
                </div>
                <p style="color: #666; margin-top: 10px; font-size: 14px;">
                    Current name: <strong id="currentSaveAsName">Not set</strong>
                </p>
            </div>

            <div class="button-row">
                <button class="btn btn-secondary" onclick="claimManager.showScreen('homeScreen')">Cancel</button>
                <button class="btn btn-success" onclick="claimManager.saveClaimAs()">üíæ Save As</button>
            </div>
        </div>

        <!-- CLAIM OPENED OPTIONS SCREEN -->
        <div class="screen" id="claimOpenedScreen">
            <h2 style="margin-bottom: 20px; text-align: center;">Claim Opened Successfully! ‚úÖ</h2>
            
            <div style="background: #f9f9f9; padding: 25px; border-radius: 10px; margin-bottom: 30px;">
                <h3 style="color: #333; margin-bottom: 15px;">üìã Claim Information:</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; font-size: 15px;">
                    <div>
                        <strong>Client:</strong> <span id="openedClientName">-</span>
                    </div>
                    <div>
                        <strong>Claim #:</strong> <span id="openedClaimNumber">-</span>
                    </div>
                    <div>
                        <strong>Loss Type:</strong> <span id="openedLossType">-</span>
                    </div>
                    <div>
                        <strong>Insurance:</strong> <span id="openedInsurance">-</span>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <strong>Address:</strong> <span id="openedAddress">-</span>
                    </div>
                </div>
            </div>

            <h3 style="margin-bottom: 20px; text-align: center; color: #666;">What would you like to do?</h3>

            <div class="home-buttons" style="margin-top: 20px;">
                <button class="home-btn" onclick="claimManager.goToEstimator()">
                    <span class="btn-icon">üèóÔ∏è</span>
                    <span class="btn-label">CONTINUE TO ESTIMATOR</span>
                    <span class="btn-desc">Work on property & estimate</span>
                </button>
                <button class="home-btn" onclick="claimManager.showScreen('clientScreen')">
                    <span class="btn-icon">‚úèÔ∏è</span>
                    <span class="btn-label">EDIT CLIENT INFO</span>
                    <span class="btn-desc">Update client details</span>
                </button>
                <button class="home-btn" onclick="claimManager.showScreen('claimScreen')">
                    <span class="btn-icon">üìù</span>
                    <span class="btn-label">EDIT CLAIM INFO</span>
                    <span class="btn-desc">Update claim details</span>
                </button>
                <button class="home-btn" onclick="claimManager.showScreen('insuranceScreen')">
                    <span class="btn-icon">üè¢</span>
                    <span class="btn-label">EDIT INSURANCE INFO</span>
                    <span class="btn-desc">Update insurance details</span>
                </button>
            </div>

            <div class="button-row" style="margin-top: 30px;">
                <button class="btn btn-secondary" onclick="claimManager.showScreen('homeScreen')">‚Üê Back to Home</button>
            </div>
        </div>

        <!-- PROPERTY ESTIMATOR SCREEN -->
        <div class="screen" id="estimatorScreen">
            <div class="loading show" id="estimatorLoading">
                <div class="spinner"></div>
                <p>Loading Property Estimator...</p>
            </div>
            <iframe id="property-estimator-frame" style="display: none;"></iframe>
        </div>
    </div>

    <script>
        // COCHRAN CLAIMS MANAGER v4.0
        class ClaimManager {
            constructor() {
                this.currentClaim = null;
                this.allClaims = [];
                this.storageKey = 'cochran-insurance-claims';
                this.init();
            }

            init() {
                // Load all claims from localStorage
                this.loadAllClaims();
                
                // Setup form handlers
                this.setupFormHandlers();
                
                // Check if we have a current claim in session
                const sessionClaim = sessionStorage.getItem('currentClaim');
                if (sessionClaim) {
                    this.currentClaim = JSON.parse(sessionClaim);
                    this.updateCurrentClaimBar();
                }

                console.log('üè† Cochran Claims Manager v4.0 Initialized');
                console.log(`üìÇ Loaded ${this.allClaims.length} existing claims`);
            }

            setupFormHandlers() {
                // Client form
                document.getElementById('clientForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveClientInfo();
                });

                // Claim form
                document.getElementById('claimForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveClaimInfo();
                });

                // Insurance form
                document.getElementById('insuranceForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveInsuranceInfo();
                });
            }

            // SCREEN MANAGEMENT
            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
            }

            // NEW CLAIM
            newClaim() {
                this.currentClaim = {
                    claimId: 'CLAIM-' + Date.now(),
                    claimName: 'Untitled Claim',
                    dateCreated: new Date().toISOString().split('T')[0],
                    dateModified: new Date().toISOString().split('T')[0],
                    clientInfo: {},
                    claimInfo: {},
                    insuranceInfo: {},
                    propertyData: null,
                    selectedItems: [],
                    estimate: null
                };

                sessionStorage.setItem('currentClaim', JSON.stringify(this.currentClaim));
                this.updateCurrentClaimBar();
                this.enableSaveButtons();
                
                // Clear forms
                document.getElementById('clientForm').reset();
                document.getElementById('claimForm').reset();
                document.getElementById('insuranceForm').reset();

                this.showScreen('clientScreen');
                this.showStatus('New claim started!', 'success');
            }

            // SAVE CLIENT INFO
            saveClientInfo() {
                const formData = new FormData(document.getElementById('clientForm'));
                this.currentClaim.clientInfo = Object.fromEntries(formData);
                
                // Update claim name
                const lastName = this.currentClaim.clientInfo.lastName || 'Unknown';
                const firstName = this.currentClaim.clientInfo.firstName || 'Unknown';
                this.currentClaim.claimName = `${lastName}-${firstName}`;
                
                sessionStorage.setItem('currentClaim', JSON.stringify(this.currentClaim));
                this.updateCurrentClaimBar();
                
                this.showScreen('claimScreen');
                this.showStatus('Client information saved!', 'success');
            }

            // SAVE CLAIM INFO
            saveClaimInfo() {
                const formData = new FormData(document.getElementById('claimForm'));
                this.currentClaim.claimInfo = Object.fromEntries(formData);
                
                // Update claim name with claim number
                const claimNumber = this.currentClaim.claimInfo.claimNumber || '';
                if (claimNumber) {
                    this.currentClaim.claimName += `-${claimNumber}`;
                }
                
                sessionStorage.setItem('currentClaim', JSON.stringify(this.currentClaim));
                this.updateCurrentClaimBar();
                
                this.showScreen('insuranceScreen');
                this.showStatus('Claim information saved!', 'success');
            }

            // SAVE INSURANCE INFO
            saveInsuranceInfo() {
                const formData = new FormData(document.getElementById('insuranceForm'));
                this.currentClaim.insuranceInfo = Object.fromEntries(formData);
                
                sessionStorage.setItem('currentClaim', JSON.stringify(this.currentClaim));
                this.updateCurrentClaimBar();
                
                // Auto-save before opening estimator
                this.saveClaim(false);
                
                this.loadPropertyEstimator();
                this.showStatus('Insurance information saved! Loading property estimator...', 'success');
            }

            // LOAD PROPERTY ESTIMATOR
            loadPropertyEstimator() {
                this.showScreen('estimatorScreen');
                
                const iframe = document.getElementById('property-estimator-frame');
                const loading = document.getElementById('estimatorLoading');
                
                // Load the Property Estimator HTML
                iframe.onload = () => {
                    loading.style.display = 'none';
                    iframe.style.display = 'block';
                    
                    console.log('üì§ Property Estimator loaded, sending claim data...');
                    console.log('   Client:', this.currentClaim.clientInfo);
                    console.log('   Claim:', this.currentClaim.claimInfo);
                    console.log('   Insurance:', this.currentClaim.insuranceInfo);
                    
                    // Pass claim data to estimator - with delay to ensure it's ready
                    const sendClaimData = () => {
                        try {
                            iframe.contentWindow.postMessage({
                                type: 'LOAD_CLAIM_DATA',
                                data: this.currentClaim
                            }, '*');
                            console.log('üì§ Sent claim data to Property Estimator');
                        } catch (e) {
                            console.log('Could not pass data to estimator:', e);
                        }
                    };
                    
                    // Send immediately
                    sendClaimData();
                    
                    // Also send after delay (in case estimator wasn't ready)
                    setTimeout(sendClaimData, 500);
                    setTimeout(sendClaimData, 1000);
                };

                iframe.onerror = () => {
                    loading.innerHTML = `
                        <div style="color: #ef4444; font-size: 16px; font-weight: bold;">
                            ‚ùå Error Loading Property Estimator
                        </div>
                        <p style="margin-top: 15px; color: #666;">
                            Make sure "Property-Estimator-FIXED.html" is in the same folder as this file.
                        </p>
                        <button class="btn btn-primary" onclick="claimManager.showScreen('homeScreen')" 
                                style="margin-top: 20px;">
                            Return to Home
                        </button>
                    `;
                };
                
                iframe.src = 'Property-Estimator-FIXED.html';
            }

            // SAVE CLAIM
            saveClaim(showMessage = true) {
                if (!this.currentClaim) {
                    this.showStatus('No claim to save!', 'error');
                    return;
                }

                // Update modified date
                this.currentClaim.dateModified = new Date().toISOString().split('T')[0];

                // Get existing claims
                let claims = this.loadAllClaims();
                
                // Find and update existing claim, or add new one
                const existingIndex = claims.findIndex(c => c.claimId === this.currentClaim.claimId);
                
                if (existingIndex >= 0) {
                    claims[existingIndex] = this.currentClaim;
                } else {
                    claims.push(this.currentClaim);
                }

                // Save to localStorage
                localStorage.setItem(this.storageKey, JSON.stringify(claims));
                
                // Update session
                sessionStorage.setItem('currentClaim', JSON.stringify(this.currentClaim));
                
                this.allClaims = claims;
                
                if (showMessage) {
                    this.showStatus(`Claim "${this.currentClaim.claimName}" saved successfully!`, 'success');
                }

                console.log('üíæ Claim saved:', this.currentClaim.claimName);
                return true;
            }

            // SHOW SAVE AS SCREEN
            showSaveAsScreen() {
                if (!this.currentClaim) {
                    this.showStatus('No claim to save!', 'error');
                    return;
                }

                document.getElementById('saveAsName').value = this.currentClaim.claimName;
                document.getElementById('currentSaveAsName').textContent = this.currentClaim.claimName;
                this.showScreen('saveAsScreen');
            }

            // SAVE AS
            saveClaimAs() {
                if (!this.currentClaim) {
                    this.showStatus('No claim to save!', 'error');
                    return;
                }

                const newName = document.getElementById('saveAsName').value.trim();
                
                if (!newName) {
                    this.showStatus('Please enter a claim name!', 'error');
                    return;
                }

                // Create new claim ID if name changed
                const oldName = this.currentClaim.claimName;
                if (newName !== oldName) {
                    this.currentClaim.claimId = 'CLAIM-' + Date.now();
                }

                this.currentClaim.claimName = newName;
                this.currentClaim.dateModified = new Date().toISOString().split('T')[0];

                if (this.saveClaim(false)) {
                    this.showStatus(`Claim saved as "${newName}"!`, 'success');
                    this.updateCurrentClaimBar();
                    this.showScreen('homeScreen');
                }
            }

            // SHOW IMPORT SCREEN
            showImportScreen() {
                // Clear previous data
                document.getElementById('importDataField').value = '';
                document.getElementById('importPreview').style.display = 'none';
                document.getElementById('importError').style.display = 'none';
                document.getElementById('importConfirmBtn').style.display = 'none';
                this.importedData = null;
                
                this.showScreen('importScreen');
            }

            // PREVIEW IMPORTED DATA
            previewImport() {
                const rawData = document.getElementById('importDataField').value.trim();
                
                if (!rawData) {
                    this.showImportError('Please paste some data first!');
                    return;
                }

                try {
                    // Try to parse the data
                    const parsedData = this.parseImportData(rawData);
                    
                    if (!parsedData) {
                        this.showImportError('Could not detect data format. Please check your data and try again.');
                        return;
                    }

                    // Store parsed data
                    this.importedData = parsedData;
                    
                    // Show preview
                    this.showImportPreview(parsedData);
                    
                    // Show import button
                    document.getElementById('importConfirmBtn').style.display = 'block';
                    
                } catch (e) {
                    this.showImportError('Error parsing data: ' + e.message);
                    console.error('Import error:', e);
                }
            }

            // PARSE IMPORT DATA (SMART DETECTION)
            parseImportData(rawData) {
                console.log('üîç Parsing import data...');
                
                // Try JSON first
                if (rawData.trim().startsWith('{') || rawData.trim().startsWith('[')) {
                    try {
                        const json = JSON.parse(rawData);
                        console.log('‚úÖ Detected JSON format');
                        return this.normalizeData(json);
                    } catch (e) {
                        console.log('‚ùå Not valid JSON');
                    }
                }

                // Try CSV/Tab-separated
                const lines = rawData.split('\n').filter(line => line.trim());
                
                // Check if it looks like CSV with header row
                if (lines.length >= 2 && (lines[0].includes(',') || lines[0].includes('\t'))) {
                    const delimiter = lines[0].includes('\t') ? '\t' : ',';
                    const headers = lines[0].split(delimiter).map(h => h.trim().toLowerCase());
                    const values = lines[1].split(delimiter).map(v => v.trim());
                    
                    if (headers.length === values.length && headers.length > 0) {
                        const data = {};
                        headers.forEach((header, i) => {
                            data[header] = values[i];
                        });
                        console.log('‚úÖ Detected CSV/Tab format with headers');
                        return this.normalizeData(data);
                    }
                }

                // Try key-value pairs (First Name: John)
                const kvPattern = /^([^:]+):\s*(.+)$/;
                if (lines.some(line => kvPattern.test(line))) {
                    const data = {};
                    lines.forEach(line => {
                        const match = line.match(kvPattern);
                        if (match) {
                            const key = match[1].trim().toLowerCase().replace(/\s+/g, '');
                            const value = match[2].trim();
                            data[key] = value;
                        }
                    });
                    if (Object.keys(data).length > 0) {
                        console.log('‚úÖ Detected key-value format');
                        return this.normalizeData(data);
                    }
                }

                // Try tab-separated without header (assume first column is label, second is value)
                if (lines.length > 0 && lines[0].includes('\t')) {
                    const data = {};
                    lines.forEach(line => {
                        const parts = line.split('\t').map(p => p.trim());
                        if (parts.length >= 2) {
                            const key = parts[0].toLowerCase().replace(/\s+/g, '');
                            const value = parts[1];
                            data[key] = value;
                        }
                    });
                    if (Object.keys(data).length > 0) {
                        console.log('‚úÖ Detected tab-separated format');
                        return this.normalizeData(data);
                    }
                }

                console.log('‚ùå Could not detect format');
                return null;
            }

            // NORMALIZE DATA (MAP TO OUR FIELD NAMES)
            normalizeData(data) {
                console.log('üìã Normalizing data:', data);
                
                const normalized = {
                    clientInfo: {},
                    claimInfo: {},
                    insuranceInfo: {}
                };

                // Create a lowercase key map
                const keyMap = {};
                Object.keys(data).forEach(key => {
                    keyMap[key.toLowerCase().replace(/[^a-z0-9]/g, '')] = data[key];
                });

                // Helper to find value by multiple possible keys
                const findValue = (...keys) => {
                    for (const key of keys) {
                        const normalized = key.toLowerCase().replace(/[^a-z0-9]/g, '');
                        if (keyMap[normalized]) return keyMap[normalized];
                    }
                    return '';
                };

                // Map client info
                normalized.clientInfo.firstName = findValue('firstName', 'first', 'fname', 'givenname');
                normalized.clientInfo.middleInitial = findValue('middleInitial', 'middleinitial', 'middle', 'mi');
                normalized.clientInfo.lastName = findValue('lastName', 'last', 'lname', 'surname', 'familyname');
                normalized.clientInfo.phone = findValue('phone', 'phoneNumber', 'mobile', 'cell', 'telephone', 'phonenumberxxxxxxxxxxxx');
                normalized.clientInfo.email = findValue('email', 'emailAddress', 'mail');
                normalized.clientInfo.address = findValue('streetAddress1', 'streetaddress1', 'address', 'street', 'streetAddress', 'propertyAddress', 'address1', 'streetaddressline1');
                normalized.clientInfo.city = findValue('city', 'town');
                normalized.clientInfo.state = findValue('state', 'province');
                normalized.clientInfo.zip = findValue('zip', 'zipCode', 'postalCode', 'postcode', 'zipcode');

                // Map claim info
                normalized.claimInfo.claimNumber = findValue('claimNumber', 'claim', 'claimNum', 'claimNo', 'claimId', 'insuranceclaimnumber');
                normalized.claimInfo.dateOfLoss = findValue('dateOfLoss', 'lossDate', 'incidentDate', 'date', 'dateofloss');
                normalized.claimInfo.lossType = findValue('lossType', 'type', 'damageType', 'incidentType', 'causeoflossperil', 'reasonforclaim');
                normalized.claimInfo.description = findValue('description', 'desc', 'details', 'notes', 'descriptionofloss');

                // Map insurance info
                normalized.insuranceInfo.company = findValue('insuranceCompany', 'insurancecompanyname', 'insurance', 'insurer', 'carrier', 'company');
                normalized.insuranceInfo.policyNumber = findValue('policyNumber', 'policy', 'policyNum', 'policyNo', 'policynumber');
                normalized.insuranceInfo.deductible = findValue('deductible', 'deduct', 'deductable');
                
                // Try to get full adjuster name or combine first + last
                const adjusterFirst = findValue('adjusterfirstname', 'adjusterFirst');
                const adjusterLast = findValue('adjusterlastname', 'adjusterLast');
                normalized.insuranceInfo.adjuster = findValue('adjuster', 'adjusterName', 'agent') || 
                                                   (adjusterFirst && adjusterLast ? `${adjusterFirst} ${adjusterLast}` : 
                                                   adjusterFirst || adjusterLast || '');
                
                normalized.insuranceInfo.adjusterPhone = findValue('adjusterPhone', 'adjusterPhoneNumber', 'agentPhone', 'adjusterphonenumber');
                normalized.insuranceInfo.adjusterEmail = findValue('adjusterEmail', 'adjusterEmailAddress', 'agentEmail', 'adjusteremail');

                console.log('‚úÖ Normalized data:', normalized);
                return normalized;
            }

            // SHOW IMPORT PREVIEW
            showImportPreview(data) {
                const preview = document.getElementById('importPreview');
                const content = document.getElementById('importPreviewContent');
                const error = document.getElementById('importError');

                error.style.display = 'none';
                
                let html = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">';
                
                // Client Info
                if (data.clientInfo && Object.values(data.clientInfo).some(v => v)) {
                    html += '<div><strong>üë§ Client Information:</strong><ul style="margin: 5px 0 0 20px; padding: 0;">';
                    if (data.clientInfo.firstName) html += `<li>First Name: ${data.clientInfo.firstName}</li>`;
                    if (data.clientInfo.lastName) html += `<li>Last Name: ${data.clientInfo.lastName}</li>`;
                    if (data.clientInfo.phone) html += `<li>Phone: ${data.clientInfo.phone}</li>`;
                    if (data.clientInfo.email) html += `<li>Email: ${data.clientInfo.email}</li>`;
                    if (data.clientInfo.address) html += `<li>Address: ${data.clientInfo.address}</li>`;
                    if (data.clientInfo.city) html += `<li>City: ${data.clientInfo.city}</li>`;
                    if (data.clientInfo.state) html += `<li>State: ${data.clientInfo.state}</li>`;
                    if (data.clientInfo.zip) html += `<li>ZIP: ${data.clientInfo.zip}</li>`;
                    html += '</ul></div>';
                }

                // Claim Info
                if (data.claimInfo && Object.values(data.claimInfo).some(v => v)) {
                    html += '<div><strong>üìã Claim Information:</strong><ul style="margin: 5px 0 0 20px; padding: 0;">';
                    if (data.claimInfo.claimNumber) html += `<li>Claim #: ${data.claimInfo.claimNumber}</li>`;
                    if (data.claimInfo.dateOfLoss) html += `<li>Date of Loss: ${data.claimInfo.dateOfLoss}</li>`;
                    if (data.claimInfo.lossType) html += `<li>Loss Type: ${data.claimInfo.lossType}</li>`;
                    if (data.claimInfo.description) html += `<li>Description: ${data.claimInfo.description.substring(0, 50)}${data.claimInfo.description.length > 50 ? '...' : ''}</li>`;
                    html += '</ul></div>';
                }

                // Insurance Info
                if (data.insuranceInfo && Object.values(data.insuranceInfo).some(v => v)) {
                    html += '<div style="grid-column: 1 / -1;"><strong>üè¢ Insurance Information:</strong><ul style="margin: 5px 0 0 20px; padding: 0;">';
                    if (data.insuranceInfo.company) html += `<li>Company: ${data.insuranceInfo.company}</li>`;
                    if (data.insuranceInfo.policyNumber) html += `<li>Policy #: ${data.insuranceInfo.policyNumber}</li>`;
                    if (data.insuranceInfo.deductible) html += `<li>Deductible: ${data.insuranceInfo.deductible}</li>`;
                    if (data.insuranceInfo.adjuster) html += `<li>Adjuster: ${data.insuranceInfo.adjuster}</li>`;
                    if (data.insuranceInfo.adjusterPhone) html += `<li>Adjuster Phone: ${data.insuranceInfo.adjusterPhone}</li>`;
                    if (data.insuranceInfo.adjusterEmail) html += `<li>Adjuster Email: ${data.insuranceInfo.adjusterEmail}</li>`;
                    html += '</ul></div>';
                }

                html += '</div>';
                content.innerHTML = html;
                preview.style.display = 'block';
            }

            // SHOW IMPORT ERROR
            showImportError(message) {
                const preview = document.getElementById('importPreview');
                const error = document.getElementById('importError');
                const errorMessage = document.getElementById('importErrorMessage');
                const confirmBtn = document.getElementById('importConfirmBtn');

                preview.style.display = 'none';
                confirmBtn.style.display = 'none';
                errorMessage.textContent = message;
                error.style.display = 'block';
            }

            // SHOW FETCH SCREEN
            showFetchScreen() {
                // Check if web app URL is configured
                const webAppUrl = localStorage.getItem('webAppUrl');
                
                if (webAppUrl) {
                    document.getElementById('webAppUrl').value = webAppUrl;
                    document.getElementById('fetchSettings').style.display = 'none';
                    document.getElementById('fetchSubmissions').style.display = 'block';
                    document.getElementById('fetchBtn').style.display = 'block';
                } else {
                    document.getElementById('fetchSettings').style.display = 'block';
                    document.getElementById('fetchSubmissions').style.display = 'none';
                    document.getElementById('fetchBtn').style.display = 'none';
                }
                
                document.getElementById('fetchError').style.display = 'none';
                document.getElementById('fetchLoading').style.display = 'none';
                
                this.showScreen('fetchScreen');
                
                // Auto-fetch if URL is configured
                if (webAppUrl) {
                    this.fetchSubmissions();
                }
            }

            // SAVE WEB APP URL
            saveWebAppUrl() {
                const url = document.getElementById('webAppUrl').value.trim();
                
                if (!url) {
                    alert('Please enter a Web App URL');
                    return;
                }
                
                if (!url.startsWith('https://script.google.com/')) {
                    alert('URL should start with https://script.google.com/');
                    return;
                }
                
                localStorage.setItem('webAppUrl', url);
                this.showStatus('Web App URL saved!', 'success');
                
                // Show submissions area
                document.getElementById('fetchSettings').style.display = 'none';
                document.getElementById('fetchSubmissions').style.display = 'block';
                document.getElementById('fetchBtn').style.display = 'block';
                
                // Auto-fetch
                this.fetchSubmissions();
            }

            // RESET WEB APP URL
            resetWebAppUrl() {
                // Confirm before resetting
                if (!confirm('Are you sure you want to reset the Web App URL?\n\nThis will clear your saved URL and you\'ll need to enter it again.')) {
                    return;
                }
                
                // Clear from localStorage
                localStorage.removeItem('webAppUrl');
                
                // Clear input field
                document.getElementById('webAppUrl').value = '';
                
                // Show settings section
                document.getElementById('fetchSettings').style.display = 'block';
                
                // Hide submissions section
                document.getElementById('fetchSubmissions').style.display = 'none';
                document.getElementById('fetchBtn').style.display = 'none';
                
                // Clear submissions list
                document.getElementById('submissionsList').innerHTML = '';
                
                // Hide any errors
                document.getElementById('fetchError').style.display = 'none';
                
                // Show success message
                this.showStatus('Web App URL has been reset. Please enter a new URL.', 'success');
            }

            // FETCH SUBMISSIONS FROM GOOGLE SHEETS
            async fetchSubmissions() {
                const webAppUrl = localStorage.getItem('webAppUrl');
                
                if (!webAppUrl) {
                    this.showFetchError('Web App URL not configured');
                    return;
                }
                
                // Show loading
                document.getElementById('fetchLoading').style.display = 'block';
                document.getElementById('submissionsList').innerHTML = '';
                document.getElementById('fetchError').style.display = 'none';
                
                try {
                    const showAll = document.getElementById('showAllSubmissions').checked;
                    const url = `${webAppUrl}?action=getNewSubmissions&onlyUnimported=${!showAll}`;
                    
                    console.log('Fetching from:', url);
                    
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    console.log('Fetch response:', data);
                    
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to fetch submissions');
                    }
                    
                    // Hide loading
                    document.getElementById('fetchLoading').style.display = 'none';
                    
                    // Display submissions
                    this.displaySubmissions(data.submissions);
                    
                } catch (error) {
                    console.error('Fetch error:', error);
                    document.getElementById('fetchLoading').style.display = 'none';
                    this.showFetchError('Error fetching submissions: ' + error.message);
                }
            }

            // DISPLAY SUBMISSIONS
            displaySubmissions(submissions) {
                const list = document.getElementById('submissionsList');
                
                if (!submissions || submissions.length === 0) {
                    list.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No submissions found</div>';
                    return;
                }
                
                let html = '';
                
                submissions.forEach((sub, index) => {
                    const imported = sub.imported ? ' (Imported in Sheet)' : '';
                    
                    // Extract key fields
                    const firstName = sub.data['First Name'] || sub.data['firstName'] || '';
                    const lastName = sub.data['Last Name'] || sub.data['lastName'] || '';
                    const timestamp = sub.data['Timestamp'] || '';
                    const claimNumber = sub.data['Claim Number'] || sub.data['claimNumber'] || '';
                    
                    html += `
                        <div style="background: white; border: 2px solid #e0e0e0; border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <h4 style="margin: 0 0 5px 0; color: #333;">
                                        ${firstName} ${lastName}${imported}
                                    </h4>
                                    <div style="color: #666; font-size: 14px;">
                                        ${timestamp ? 'üìÖ ' + timestamp : ''}
                                        ${claimNumber ? ' | üî¢ ' + claimNumber : ''}
                                    </div>
                                </div>
                                <button class="btn btn-success btn-sm" 
                                        onclick="claimManager.importSubmission(${index})">
                                    ‚úÖ Import
                                </button>
                            </div>
                            <details style="cursor: pointer;">
                                <summary style="color: #667eea; font-weight: 600;">View Details</summary>
                                <div style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; font-size: 13px; max-height: 200px; overflow-y: auto;">
                                    ${this.formatSubmissionDetails(sub.data)}
                                </div>
                            </details>
                        </div>
                    `;
                });
                
                list.innerHTML = html;
                
                // Store submissions for later use
                this.currentSubmissions = submissions;
            }

            // FORMAT SUBMISSION DETAILS
            formatSubmissionDetails(data) {
                let html = '<div style="line-height: 1.8;">';
                
                for (const [key, value] of Object.entries(data)) {
                    if (value) {
                        html += `<div><strong>${key}:</strong> ${value}</div>`;
                    }
                }
                
                html += '</div>';
                return html;
            }

            // IMPORT SUBMISSION
            importSubmission(index) {
                if (!this.currentSubmissions || !this.currentSubmissions[index]) {
                    this.showStatus('Submission not found', 'error');
                    return;
                }
                
                const submission = this.currentSubmissions[index];
                
                // Normalize data
                const normalized = this.normalizeData(submission.data);
                
                // Create claim
                this.currentClaim = {
                    claimId: 'CLAIM-' + Date.now(),
                    claimName: 'Fetched Claim',
                    dateCreated: new Date().toISOString().split('T')[0],
                    dateModified: new Date().toISOString().split('T')[0],
                    clientInfo: normalized.clientInfo || {},
                    claimInfo: normalized.claimInfo || {},
                    insuranceInfo: normalized.insuranceInfo || {},
                    propertyData: null,
                    selectedItems: [],
                    estimate: null,
                    sourceRowIndex: submission.rowIndex
                };
                
                // Update claim name
                const lastName = this.currentClaim.clientInfo.lastName || 'Unknown';
                const firstName = this.currentClaim.clientInfo.firstName || 'Unknown';
                const claimNumber = this.currentClaim.claimInfo.claimNumber || '';
                this.currentClaim.claimName = `${lastName}-${firstName}${claimNumber ? '-' + claimNumber : ''}`;
                
                // Save claim
                sessionStorage.setItem('currentClaim', JSON.stringify(this.currentClaim));
                this.updateCurrentClaimBar();
                this.enableSaveButtons();
                this.populateForms();
                
                // Auto-save
                this.saveClaim(false);
                
                // Mark as imported in Google Sheets
                this.markAsImported(submission.rowIndex);
                
                // Show success and go to opened claim screen
                this.showStatus(`Imported claim: ${this.currentClaim.claimName}`, 'success');
                this.showClaimOpenedOptions();
                
                console.log('üì• Claim imported successfully:', this.currentClaim.claimName);
            }

            // MARK AS IMPORTED IN GOOGLE SHEETS
            async markAsImported(rowIndex) {
                const webAppUrl = localStorage.getItem('webAppUrl');
                
                if (!webAppUrl) return;
                
                try {
                    await fetch(webAppUrl, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'markImported',
                            rowIndex: rowIndex
                        })
                    });
                    
                    console.log('Marked row ' + rowIndex + ' as imported');
                } catch (error) {
                    console.error('Error marking as imported:', error);
                }
            }

            // SHOW FETCH ERROR
            showFetchError(message) {
                const errorDiv = document.getElementById('fetchError');
                const errorMessage = document.getElementById('fetchErrorMessage');
                
                errorMessage.textContent = message;
                errorDiv.style.display = 'block';
            }

            // SHOW SETUP INSTRUCTIONS
            showSetupInstructions() {
                alert(`üìñ Setup Instructions:

1. Open your Google Sheet
2. Go to Extensions ‚Üí Apps Script
3. Add the Web App code (provided separately)
4. Click Deploy ‚Üí New deployment
5. Select type: Web app
6. Execute as: Me
7. Who has access: Anyone
8. Click Deploy
9. Copy the Web App URL
10. Paste it here and click Save

Check the documentation for complete instructions!`);
            }

            // IMPORT CLAIM (CREATE FROM PARSED DATA)
            importClaim() {
                if (!this.importedData) {
                    this.showStatus('No data to import!', 'error');
                    return;
                }

                // Create new claim with imported data
                this.currentClaim = {
                    claimId: 'CLAIM-' + Date.now(),
                    claimName: 'Imported Claim',
                    dateCreated: new Date().toISOString().split('T')[0],
                    dateModified: new Date().toISOString().split('T')[0],
                    clientInfo: this.importedData.clientInfo || {},
                    claimInfo: this.importedData.claimInfo || {},
                    insuranceInfo: this.importedData.insuranceInfo || {},
                    propertyData: null,
                    selectedItems: [],
                    estimate: null
                };

                // Update claim name
                const lastName = this.currentClaim.clientInfo.lastName || 'Unknown';
                const firstName = this.currentClaim.clientInfo.firstName || 'Unknown';
                const claimNumber = this.currentClaim.claimInfo.claimNumber || '';
                this.currentClaim.claimName = `${lastName}-${firstName}${claimNumber ? '-' + claimNumber : ''}`;

                // Save claim
                sessionStorage.setItem('currentClaim', JSON.stringify(this.currentClaim));
                this.updateCurrentClaimBar();
                this.enableSaveButtons();
                this.populateForms();

                // Auto-save
                this.saveClaim(false);

                // Show success and go to opened claim screen
                this.showStatus(`Imported claim: ${this.currentClaim.claimName}`, 'success');
                this.showClaimOpenedOptions();

                console.log('üì• Claim imported successfully:', this.currentClaim.claimName);
            }

            // OPEN CLAIM
            showOpenScreen() {
                this.showScreen('openScreen');
                this.displayAllClaims();
            }

            // SEARCH CLAIMS
            searchClaims() {
                const lastName = document.getElementById('searchLastName').value.trim().toLowerCase();
                const firstName = document.getElementById('searchFirstName').value.trim().toLowerCase();

                let filtered = this.allClaims;

                if (lastName) {
                    filtered = filtered.filter(claim => 
                        claim.clientInfo.lastName?.toLowerCase().includes(lastName)
                    );
                }

                if (firstName) {
                    filtered = filtered.filter(claim => 
                        claim.clientInfo.firstName?.toLowerCase().includes(firstName)
                    );
                }

                this.displayClaims(filtered);
            }

            // DISPLAY CLAIMS
            displayAllClaims() {
                this.displayClaims(this.allClaims);
            }

            displayClaims(claims) {
                const list = document.getElementById('claimsList');
                
                if (claims.length === 0) {
                    list.innerHTML = '<div class="no-claims">No claims found matching your search.</div>';
                    return;
                }

                list.innerHTML = claims.map(claim => `
                    <div class="claim-item" onclick="claimManager.openClaim('${claim.claimId}')">
                        <div class="claim-name">${claim.claimName}</div>
                        <div class="claim-details">
                            ${claim.clientInfo.firstName || ''} ${claim.clientInfo.lastName || ''} | 
                            ${claim.claimInfo.lossType || 'N/A'} | 
                            Claim #${claim.claimInfo.claimNumber || 'N/A'}
                        </div>
                        <div class="claim-date">
                            Created: ${claim.dateCreated} | Modified: ${claim.dateModified}
                        </div>
                    </div>
                `).join('');
            }

            // OPEN SPECIFIC CLAIM
            openClaim(claimId) {
                const claim = this.allClaims.find(c => c.claimId === claimId);
                
                if (!claim) {
                    this.showStatus('Claim not found!', 'error');
                    return;
                }

                this.currentClaim = claim;
                sessionStorage.setItem('currentClaim', JSON.stringify(this.currentClaim));
                
                this.updateCurrentClaimBar();
                this.enableSaveButtons();
                this.populateForms();
                
                // Show a modal with options
                this.showClaimOpenedOptions();
                
                console.log('üìÇ Opened claim:', claim.claimName);
            }

            // SHOW OPTIONS AFTER OPENING CLAIM
            showClaimOpenedOptions() {
                // Populate claim info display
                const client = this.currentClaim.clientInfo;
                const claim = this.currentClaim.claimInfo;
                const insurance = this.currentClaim.insuranceInfo;

                document.getElementById('openedClientName').textContent = 
                    `${client.firstName || ''} ${client.lastName || ''}`.trim() || 'N/A';
                
                document.getElementById('openedClaimNumber').textContent = 
                    claim.claimNumber || 'N/A';
                
                document.getElementById('openedLossType').textContent = 
                    claim.lossType || 'N/A';
                
                document.getElementById('openedInsurance').textContent = 
                    insurance.company || 'N/A';
                
                document.getElementById('openedAddress').textContent = 
                    `${client.address || ''}, ${client.city || ''}, ${client.state || ''} ${client.zip || ''}`.replace(/,\s*,/g, ',').trim() || 'N/A';

                this.showScreen('claimOpenedScreen');
                this.showStatus(`Opened claim: ${this.currentClaim.claimName}`, 'success');
            }

            // GO TO ESTIMATOR FROM OPENED CLAIM
            goToEstimator() {
                this.loadPropertyEstimator();
            }

            // POPULATE FORMS WITH CURRENT CLAIM DATA
            populateForms() {
                if (!this.currentClaim) return;

                // Populate client form
                const clientForm = document.getElementById('clientForm');
                Object.keys(this.currentClaim.clientInfo).forEach(key => {
                    const input = clientForm.querySelector(`[name="${key}"]`);
                    if (input) input.value = this.currentClaim.clientInfo[key] || '';
                });

                // Populate claim form
                const claimForm = document.getElementById('claimForm');
                Object.keys(this.currentClaim.claimInfo).forEach(key => {
                    const input = claimForm.querySelector(`[name="${key}"]`);
                    if (input) input.value = this.currentClaim.claimInfo[key] || '';
                });

                // Populate insurance form
                const insuranceForm = document.getElementById('insuranceForm');
                Object.keys(this.currentClaim.insuranceInfo).forEach(key => {
                    const input = insuranceForm.querySelector(`[name="${key}"]`);
                    if (input) input.value = this.currentClaim.insuranceInfo[key] || '';
                });
            }

            // LOAD ALL CLAIMS
            loadAllClaims() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    this.allClaims = stored ? JSON.parse(stored) : [];
                    return this.allClaims;
                } catch (e) {
                    console.error('Error loading claims:', e);
                    this.allClaims = [];
                    return [];
                }
            }

            // UPDATE CURRENT CLAIM BAR
            updateCurrentClaimBar() {
                const bar = document.getElementById('currentClaimBar');
                const nameEl = document.getElementById('currentClaimName');
                const dateEl = document.getElementById('currentClaimDate');

                if (this.currentClaim) {
                    bar.classList.add('show');
                    nameEl.textContent = this.currentClaim.claimName;
                    dateEl.textContent = `Modified: ${this.currentClaim.dateModified}`;
                } else {
                    bar.classList.remove('show');
                }
            }

            // ENABLE SAVE BUTTONS
            enableSaveButtons() {
                document.getElementById('homeSaveBtn').disabled = false;
                document.getElementById('homeSaveBtn').style.opacity = '1';
                document.getElementById('homeSaveAsBtn').disabled = false;
                document.getElementById('homeSaveAsBtn').style.opacity = '1';
            }

            // RETURN HOME
            returnHome() {
                // Save current claim before returning
                if (this.currentClaim) {
                    this.saveClaim(false);
                }
                this.showScreen('homeScreen');
            }

            // SHOW STATUS MESSAGE
            showStatus(message, type = 'success') {
                const statusEl = document.getElementById('statusMessage');
                statusEl.textContent = message;
                statusEl.className = `status-message show ${type}`;
                
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 5000);
            }
        }

        // Initialize on page load
        let claimManager;
        window.addEventListener('DOMContentLoaded', () => {
            claimManager = new ClaimManager();
        });

        // Listen for messages from Property Estimator iframe
        window.addEventListener('message', (event) => {
            if (event.data.type === 'ESTIMATOR_DATA_UPDATED') {
                // Update current claim with estimator data
                if (claimManager.currentClaim) {
                    claimManager.currentClaim.propertyData = event.data.propertyData;
                    claimManager.currentClaim.selectedItems = event.data.selectedItems;
                    claimManager.currentClaim.estimate = event.data.estimate;
                    
                    // Auto-save
                    claimManager.saveClaim(false);
                    console.log('üìä Estimator data auto-saved to claim');
                }
            }
        });

        // Console welcome message
        console.log('%cüè† COCHRAN INSURANCE CLAIMS MANAGER v4.5', 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 16px; font-weight: bold; padding: 10px;');
        console.log('%c‚úÖ NEW: Auto-Fetch from Google Forms!', 'color: #667eea; font-size: 14px; font-weight: bold;');
        console.log('%cüîÑ Fetch new submissions with one click - no copy/paste!', 'color: #666; font-size: 12px;');
        console.log('%cüì• Import feature still available for manual use', 'color: #666; font-size: 12px;');
        console.log('%cüìÇ Storage: cochran-insurance-claims (localStorage)', 'color: #666; font-size: 12px;');
        console.log('%cüíæ Auto-save: Claims saved automatically', 'color: #666; font-size: 12px;');
    </script>
</body>
</html>
