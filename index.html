<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cochran Claims Manager - Firebase</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .company-logo {
            font-size: 42px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .company-tagline { color: #666; font-size: 16px; }

        .screen {
            display: none;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .screen.active { display: block; }

        .home-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .home-btn {
            padding: 40px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .home-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
        }

        .home-btn:active { transform: translateY(-1px); }

        .btn-icon { font-size: 48px; display: block; margin-bottom: 15px; }
        .btn-label { font-size: 20px; display: block; }
        .btn-desc { font-size: 13px; opacity: 0.9; margin-top: 8px; font-weight: 400; }

        .form-section { margin-bottom: 35px; }

        .form-section-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }

        label { font-weight: 600; color: #333; margin-bottom: 8px; font-size: 14px; }

        input, select, textarea {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px !important;
            font-family: inherit;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea { min-height: 100px; resize: vertical; }

        .button-row {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary { background: #f5f5f5; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; }

        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }

        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }

        .search-box { display: flex; gap: 15px; margin-bottom: 30px; }
        .search-box input { flex: 1; }

        .claims-list {
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .claim-item {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .claim-item:hover { background: #f9f9f9; }
        .claim-item:last-child { border-bottom: none; }

        .claim-item-info { flex: 1; }
        .claim-name { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 5px; }
        .claim-details { font-size: 14px; color: #666; }
        .claim-date { font-size: 12px; color: #999; margin-top: 5px; }

        .claim-item-actions { display: flex; gap: 8px; flex-shrink: 0; margin-left: 15px; }

        .btn-sm {
            padding: 8px 14px;
            font-size: 13px;
            min-height: 36px;
        }

        .no-claims { text-align: center; padding: 60px 20px; color: #999; font-size: 16px; }

        .status-message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            display: none;
        }

        .status-message.show { display: block; }

        .status-message.success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }

        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }

        .current-claim-bar {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .current-claim-bar.show { display: flex; }

        .current-claim-info { font-weight: 600; }
        .current-claim-name { font-size: 18px; margin-bottom: 3px; }
        .current-claim-date { font-size: 13px; opacity: 0.9; }

        #property-estimator-frame {
            width: 100%;
            height: calc(100vh - 100px);
            border: none;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .loading { display: none; text-align: center; padding: 40px; }
        .loading.show { display: block; }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Firebase status badge */
        .firebase-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #fff3e0;
            border: 1px solid #ff9800;
            color: #e65100;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .firebase-badge.connected {
            background: #e8f5e9;
            border-color: #10b981;
            color: #065f46;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header { padding: 15px; margin-bottom: 15px; }
            .company-logo { font-size: 26px; }
            .screen { padding: 15px; }
            .home-btn { min-height: 100px; padding: 20px; }
            .btn-icon { font-size: 36px; margin-bottom: 8px; }
            .btn-label { font-size: 18px; }
            .home-buttons { grid-template-columns: 1fr; gap: 15px; }
            .form-grid { grid-template-columns: 1fr; gap: 15px; }
            .button-row { flex-direction: column; gap: 10px; }
            .btn { width: 100%; }
            .current-claim-bar { flex-direction: column; gap: 10px; padding: 12px; }
            .current-claim-name { font-size: 16px; }
            .claim-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .claim-item-actions { margin-left: 0; }
        }

        @media (max-width: 430px) {
            .company-logo { font-size: 22px; }
            .home-btn { min-height: 85px; padding: 15px; }
            .btn-icon { font-size: 30px; }
            .btn-label { font-size: 16px; }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .home-buttons { grid-template-columns: repeat(2, 1fr); }
            .form-grid { grid-template-columns: repeat(2, 1fr); }
        }

        * { -webkit-overflow-scrolling: touch; touch-action: manipulation; }
        button, a, input[type="submit"], input[type="button"], select { min-height: 44px; }
    </style>
</head>
<body>
<div class="container">

    <!-- Header -->
    <div class="header">
        <div class="company-logo">üè† COCHRAN CLAIMS</div>
        <div class="company-tagline">Professional Insurance Claims Management</div>
        <div class="firebase-badge" id="firebaseBadge">‚è≥ Connecting to Firebase...</div>
    </div>

    <!-- Current Claim Info Bar -->
    <div class="current-claim-bar" id="currentClaimBar">
        <div class="current-claim-info">
            <div class="current-claim-name" id="currentClaimName">No Claim Loaded</div>
            <div class="current-claim-date" id="currentClaimDate"></div>
        </div>
        <button class="btn btn-secondary" onclick="claimManager.returnHome()">‚Üê Back to Home</button>
    </div>

    <!-- Status Message -->
    <div class="status-message" id="statusMessage"></div>

    <!-- HOME SCREEN -->
    <div class="screen active" id="homeScreen">
        <h1 style="text-align: center; margin-bottom: 40px; color: #333;">Claim Management</h1>
        <div class="home-buttons">
            <button class="home-btn" onclick="claimManager.newClaim()">
                <span class="btn-icon">üìù</span>
                <span class="btn-label">NEW</span>
                <span class="btn-desc">Start a new claim</span>
            </button>
            <button class="home-btn" onclick="claimManager.showOpenScreen()">
                <span class="btn-icon">üìÇ</span>
                <span class="btn-label">OPEN</span>
                <span class="btn-desc">Open existing claim</span>
            </button>
            <button class="home-btn" onclick="claimManager.showImportScreen()">
                <span class="btn-icon">üì•</span>
                <span class="btn-label">IMPORT</span>
                <span class="btn-desc">Import from clipboard</span>
            </button>
            <button class="home-btn" onclick="claimManager.saveClaim()" id="homeSaveBtn" style="opacity: 0.5;" disabled>
                <span class="btn-icon">üíæ</span>
                <span class="btn-label">SAVE</span>
                <span class="btn-desc">Save current claim</span>
            </button>
            <button class="home-btn" onclick="claimManager.showSaveAsScreen()" id="homeSaveAsBtn" style="opacity: 0.5;" disabled>
                <span class="btn-icon">üì§</span>
                <span class="btn-label">SAVE AS</span>
                <span class="btn-desc">Save with new name</span>
            </button>
        </div>
    </div>

    <!-- OPEN SCREEN -->
    <div class="screen" id="openScreen">
        <h2 style="margin-bottom: 30px;">Open Existing Claim</h2>
        <div class="search-box">
            <input type="text" id="searchLastName" placeholder="Last Name" oninput="claimManager.searchClaims()">
            <input type="text" id="searchFirstName" placeholder="First Name" oninput="claimManager.searchClaims()">
            <button class="btn btn-primary" onclick="claimManager.searchClaims()">üîç Search</button>
        </div>
        <div class="claims-list" id="claimsList">
            <div class="no-claims">Loading claims from Firebase...</div>
        </div>
        <div class="button-row">
            <button class="btn btn-secondary" onclick="claimManager.showScreen('homeScreen')">Cancel</button>
        </div>
    </div>

    <!-- IMPORT SCREEN -->
    <div class="screen" id="importScreen">
        <h2 style="margin-bottom: 20px;">üì• Import Claim Data</h2>
        <p style="color: #666; margin-bottom: 25px; line-height: 1.6;">
            Paste data from any spreadsheet or form. The system will automatically detect the format and populate all fields.
        </p>
        <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 15px 0; color: #555; font-size: 16px;">üìã Supported Formats:</h3>
            <ul style="margin: 0; padding-left: 20px; color: #666; line-height: 1.8;">
                <li><strong>JSON</strong> ‚Äî Exported claim or form data</li>
                <li><strong>CSV</strong> ‚Äî Copy from any spreadsheet</li>
                <li><strong>Tab-separated</strong> ‚Äî Copy directly from spreadsheet cells</li>
                <li><strong>Plain text</strong> ‚Äî Key: Value format</li>
            </ul>
        </div>
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #555;">Paste Your Data Here:</label>
            <textarea id="importDataField"
                      style="width: 100%; min-height: 300px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; resize: vertical;"
                      placeholder="Paste data here...

JSON:
{&quot;firstName&quot;: &quot;John&quot;, &quot;lastName&quot;: &quot;Smith&quot;, &quot;address&quot;: &quot;123 Main St&quot;}

CSV:
firstName,lastName,address,city,state,zip
John,Smith,123 Main St,Dallas,TX,75001

Key:Value:
First Name: John
Last Name: Smith
Address: 123 Main St"></textarea>
        </div>

        <div id="importPreview" style="display: none; background: #e8f5e9; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
            <h3 style="margin: 0 0 15px 0; color: #2e7d32;">‚úÖ Data Detected!</h3>
            <div id="importPreviewContent" style="font-size: 14px; color: #555; line-height: 1.6;"></div>
        </div>

        <div id="importError" style="display: none; background: #ffebee; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #f44336;">
            <h3 style="margin: 0 0 10px 0; color: #c62828;">‚ùå Could Not Parse Data</h3>
            <div id="importErrorMessage" style="font-size: 14px; color: #666;"></div>
        </div>

        <div class="button-row">
            <button class="btn btn-secondary" onclick="claimManager.showScreen('homeScreen')">Cancel</button>
            <button class="btn btn-primary" onclick="claimManager.previewImport()">üëÄ Preview Data</button>
            <button class="btn btn-success" onclick="claimManager.importClaim()" id="importConfirmBtn" style="display: none;">‚úÖ Import Claim</button>
        </div>
    </div>

    <!-- CLIENT INFO SCREEN -->
    <div class="screen" id="clientScreen">
        <h2 style="margin-bottom: 30px;">Client Information</h2>
        <form id="clientForm">
            <div class="form-section">
                <div class="form-section-title">Personal Information</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input type="text" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name *</label>
                        <input type="text" name="lastName" required>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" name="phone" placeholder="(555) 123-4567">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" placeholder="client@example.com">
                    </div>
                </div>
            </div>
            <div class="form-section">
                <div class="form-section-title">Property Address</div>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>Street Address *</label>
                        <input type="text" name="address" required>
                    </div>
                    <div class="form-group">
                        <label>City *</label>
                        <input type="text" name="city" required>
                    </div>
                    <div class="form-group">
                        <label>State *</label>
                        <input type="text" name="state" required>
                    </div>
                    <div class="form-group">
                        <label>ZIP Code *</label>
                        <input type="text" name="zip" required>
                    </div>
                </div>
            </div>
            <div class="button-row">
                <button type="button" class="btn btn-secondary" onclick="claimManager.showScreen('homeScreen')">Cancel</button>
                <button type="submit" class="btn btn-primary">Next: Claim Info ‚Üí</button>
            </div>
        </form>
    </div>

    <!-- CLAIM INFO SCREEN -->
    <div class="screen" id="claimScreen">
        <h2 style="margin-bottom: 30px;">Claim Information</h2>
        <form id="claimForm">
            <div class="form-section">
                <div class="form-section-title">Claim Details</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Claim Number *</label>
                        <input type="text" name="claimNumber" required>
                    </div>
                    <div class="form-group">
                        <label>Date of Loss *</label>
                        <input type="date" name="dateOfLoss" required>
                    </div>
                    <div class="form-group full-width">
                        <label>Loss Type *</label>
                        <select name="lossType" required>
                            <option value="">Select loss type...</option>
                            <option value="Water Damage">Water Damage</option>
                            <option value="Fire">Fire</option>
                            <option value="Storm">Storm</option>
                            <option value="Wind">Wind</option>
                            <option value="Hail">Hail</option>
                            <option value="Theft">Theft</option>
                            <option value="Vandalism">Vandalism</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>Description of Loss</label>
                        <textarea name="description" placeholder="Describe the damage and circumstances..."></textarea>
                    </div>
                </div>
            </div>
            <div class="button-row">
                <button type="button" class="btn btn-secondary" onclick="claimManager.showScreen('clientScreen')">‚Üê Back</button>
                <button type="submit" class="btn btn-primary">Next: Insurance Info ‚Üí</button>
            </div>
        </form>
    </div>

    <!-- INSURANCE INFO SCREEN -->
    <div class="screen" id="insuranceScreen">
        <h2 style="margin-bottom: 30px;">Insurance Information</h2>
        <form id="insuranceForm">
            <div class="form-section">
                <div class="form-section-title">Insurance Company</div>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>Insurance Company *</label>
                        <input type="text" name="company" required>
                    </div>
                    <div class="form-group full-width">
                        <label>Policy Number *</label>
                        <input type="text" name="policyNumber" required>
                    </div>
                    <div class="form-group">
                        <label>Deductible</label>
                        <input type="text" name="deductible" placeholder="$1,000">
                    </div>
                </div>
            </div>
            <div class="form-section">
                <div class="form-section-title">Adjuster Information</div>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>Adjuster Name</label>
                        <input type="text" name="adjuster">
                    </div>
                    <div class="form-group">
                        <label>Adjuster Phone</label>
                        <input type="tel" name="adjusterPhone" placeholder="(555) 123-4567">
                    </div>
                    <div class="form-group">
                        <label>Adjuster Email</label>
                        <input type="email" name="adjusterEmail">
                    </div>
                </div>
            </div>
            <div class="button-row">
                <button type="button" class="btn btn-secondary" onclick="claimManager.showScreen('claimScreen')">‚Üê Back</button>
                <button type="submit" class="btn btn-success">Open Property Estimator ‚Üí</button>
            </div>
        </form>
    </div>

    <!-- SAVE AS SCREEN -->
    <div class="screen" id="saveAsScreen">
        <h2 style="margin-bottom: 30px;">Save Claim As...</h2>
        <div class="form-section">
            <div class="form-group">
                <label>Claim Name</label>
                <input type="text" id="saveAsName" placeholder="LastName-FirstName-ClaimNumber">
            </div>
            <p style="color: #666; margin-top: 10px; font-size: 14px;">
                Current name: <strong id="currentSaveAsName">Not set</strong>
            </p>
        </div>
        <div class="button-row">
            <button class="btn btn-secondary" onclick="claimManager.showScreen('homeScreen')">Cancel</button>
            <button class="btn btn-success" onclick="claimManager.saveClaimAs()">üíæ Save As</button>
        </div>
    </div>

    <!-- CLAIM OPENED OPTIONS SCREEN -->
    <div class="screen" id="claimOpenedScreen">
        <h2 style="margin-bottom: 20px; text-align: center;">Claim Opened Successfully! ‚úÖ</h2>
        <div style="background: #f9f9f9; padding: 25px; border-radius: 10px; margin-bottom: 30px;">
            <h3 style="color: #333; margin-bottom: 15px;">üìã Claim Information:</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; font-size: 15px;">
                <div><strong>Client:</strong> <span id="openedClientName">-</span></div>
                <div><strong>Claim #:</strong> <span id="openedClaimNumber">-</span></div>
                <div><strong>Loss Type:</strong> <span id="openedLossType">-</span></div>
                <div><strong>Insurance:</strong> <span id="openedInsurance">-</span></div>
                <div style="grid-column: 1 / -1;"><strong>Address:</strong> <span id="openedAddress">-</span></div>
            </div>
        </div>
        <h3 style="margin-bottom: 20px; text-align: center; color: #666;">What would you like to do?</h3>
        <div class="home-buttons" style="margin-top: 20px;">
            <button class="home-btn" onclick="claimManager.goToEstimator()">
                <span class="btn-icon">üèóÔ∏è</span>
                <span class="btn-label">CONTINUE TO ESTIMATOR</span>
                <span class="btn-desc">Work on property &amp; estimate</span>
            </button>
            <button class="home-btn" onclick="claimManager.showScreen('clientScreen')">
                <span class="btn-icon">‚úèÔ∏è</span>
                <span class="btn-label">EDIT CLIENT INFO</span>
                <span class="btn-desc">Update client details</span>
            </button>
            <button class="home-btn" onclick="claimManager.showScreen('claimScreen')">
                <span class="btn-icon">üìù</span>
                <span class="btn-label">EDIT CLAIM INFO</span>
                <span class="btn-desc">Update claim details</span>
            </button>
            <button class="home-btn" onclick="claimManager.showScreen('insuranceScreen')">
                <span class="btn-icon">üè¢</span>
                <span class="btn-label">EDIT INSURANCE INFO</span>
                <span class="btn-desc">Update insurance details</span>
            </button>
        </div>
        <div class="button-row" style="margin-top: 30px;">
            <button class="btn btn-secondary" onclick="claimManager.showScreen('homeScreen')">‚Üê Back to Home</button>
        </div>
    </div>

    <!-- PROPERTY ESTIMATOR SCREEN -->
    <div class="screen" id="estimatorScreen">
        <div class="loading show" id="estimatorLoading">
            <div class="spinner"></div>
            <p>Loading Property Estimator...</p>
        </div>
        <iframe id="property-estimator-frame" style="display: none;"></iframe>
    </div>

</div>

<!-- ============================================================
     FIREBASE SDK (compat v9)
     Replace the firebaseConfig values below with your
     cochran-claims Firebase project credentials.
     ============================================================ -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    // ‚îÄ‚îÄ‚îÄ FIREBASE CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Replace these values with your cochran-claims Firebase project settings.
    // Firebase Console ‚Üí Project Settings ‚Üí Your Apps ‚Üí SDK setup & configuration
    const firebaseConfig = {
        apiKey:            "AIzaSyB5v7ICjvpK1z7pMvvBhZWSYjGp_ac_A9U",
        authDomain:        "cochran-claims.firebaseapp.com",
        projectId:         "cochran-claims",
        storageBucket:     "cochran-claims.firebasestorage.app",
        messagingSenderId: "307914286893",
        appId:             "1:307914286893:web:5a3692614ee69b83a6d5a4",
        measurementId:     "G-RX6S4YR1KE"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    // Update badge once we can reach Firestore
    db.collection('claims').limit(1).get()
        .then(() => {
            const badge = document.getElementById('firebaseBadge');
            badge.textContent = 'üî• Firebase Connected';
            badge.classList.add('connected');
        })
        .catch(err => {
            const badge = document.getElementById('firebaseBadge');
            badge.textContent = '‚ö†Ô∏è Firebase Offline ‚Äî check config';
            console.warn('Firebase connection error:', err);
        });
</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COCHRAN CLAIMS MANAGER v5.0  ‚Äî Firebase Edition
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
class ClaimManager {
    constructor() {
        this.currentClaim  = null;
        this.allClaims     = [];
        this.COLLECTION    = 'claims'; // Firestore collection name
        this.init();
    }

    // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async init() {
        this.setupFormHandlers();
        this.setupPropertyEstimatorListener();

        // Restore session claim if available
        const sessionClaim = sessionStorage.getItem('currentClaim');
        if (sessionClaim) {
            this.currentClaim = JSON.parse(sessionClaim);
            this.updateCurrentClaimBar();
            this.enableSaveButtons();
        }

        // Preload claims from Firestore
        await this.loadAllClaims();

        console.log('%cüè† COCHRAN CLAIMS MANAGER v5.0 ‚Äî Firebase Edition',
            'background:linear-gradient(135deg,#667eea,#764ba2);color:white;font-size:14px;font-weight:bold;padding:8px;');
        console.log(`üìÇ Loaded ${this.allClaims.length} claims from Firestore`);
    }

    // ‚îÄ‚îÄ PROPERTY ESTIMATOR MESSAGING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    setupPropertyEstimatorListener() {
        window.addEventListener('message', (event) => {
            if (event.data?.type === 'SAVE_PROPERTY_DATA') {
                this.savePropertyData(event.data.propertyData);
            }
            if (event.data?.type === 'RETURN_TO_HOME') {
                setTimeout(() => this.showScreen('homeScreen'), 500);
            }
        });
    }

    savePropertyData(propertyData) {
        if (!this.currentClaim) {
            this.showStatus('‚ùå No active claim to save property data to.', 'error');
            return;
        }
        const roomCount = propertyData.rooms?.length ?? 0;
        const itemCount = propertyData.selectedItems?.length ?? 0;

        this.currentClaim.propertyData   = propertyData;
        this.currentClaim.dateModified   = this._today();
        sessionStorage.setItem('currentClaim', JSON.stringify(this.currentClaim));

        this.saveClaim(false);
        this.showStatus(`‚úÖ Property data saved! (${roomCount} rooms, ${itemCount} items)`, 'success');
    }

    // ‚îÄ‚îÄ FORM HANDLERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    setupFormHandlers() {
        document.getElementById('clientForm').addEventListener('submit',    (e) => { e.preventDefault(); this.saveClientInfo(); });
        document.getElementById('claimForm').addEventListener('submit',     (e) => { e.preventDefault(); this.saveClaimInfo(); });
        document.getElementById('insuranceForm').addEventListener('submit', (e) => { e.preventDefault(); this.saveInsuranceInfo(); });
    }

    // ‚îÄ‚îÄ SCREEN MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    }

    // ‚îÄ‚îÄ NEW CLAIM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    newClaim() {
        this.currentClaim = {
            claimId:       'CLAIM-' + Date.now(),
            claimName:     'Untitled Claim',
            dateCreated:   this._today(),
            dateModified:  this._today(),
            clientInfo:    {},
            claimInfo:     {},
            insuranceInfo: {},
            propertyData:  null,
            selectedItems: [],
            estimate:      null
        };
        sessionStorage.setItem('currentClaim', JSON.stringify(this.currentClaim));
        this.updateCurrentClaimBar();
        this.enableSaveButtons();

        document.getElementById('clientForm').reset();
        document.getElementById('claimForm').reset();
        document.getElementById('insuranceForm').reset();

        this.showScreen('clientScreen');
        this.showStatus('New claim started!', 'success');
    }

    // ‚îÄ‚îÄ SAVE CLIENT INFO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    saveClientInfo() {
        const fd = new FormData(document.getElementById('clientForm'));
        this.currentClaim.clientInfo = Object.fromEntries(fd);

        const last  = this.currentClaim.clientInfo.lastName  || 'Unknown';
        const first = this.currentClaim.clientInfo.firstName || 'Unknown';
        this.currentClaim.claimName = `${last}-${first}`;

        sessionStorage.setItem('currentClaim', JSON.stringify(this.currentClaim));
        this.updateCurrentClaimBar();
        this.showScreen('claimScreen');
        this.showStatus('Client information saved!', 'success');
    }

    // ‚îÄ‚îÄ SAVE CLAIM INFO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    saveClaimInfo() {
        const fd = new FormData(document.getElementById('claimForm'));
        this.currentClaim.claimInfo = Object.fromEntries(fd);

        const num = this.currentClaim.claimInfo.claimNumber;
        if (num) this.currentClaim.claimName += `-${num}`;

        sessionStorage.setItem('currentClaim', JSON.stringify(this.currentClaim));
        this.updateCurrentClaimBar();
        this.showScreen('insuranceScreen');
        this.showStatus('Claim information saved!', 'success');
    }

    // ‚îÄ‚îÄ SAVE INSURANCE INFO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    saveInsuranceInfo() {
        const fd = new FormData(document.getElementById('insuranceForm'));
        this.currentClaim.insuranceInfo = Object.fromEntries(fd);

        sessionStorage.setItem('currentClaim', JSON.stringify(this.currentClaim));
        this.updateCurrentClaimBar();
        this.saveClaim(false);

        this.loadPropertyEstimator();
        this.showStatus('Insurance information saved! Loading property estimator...', 'success');
    }

    // ‚îÄ‚îÄ LOAD PROPERTY ESTIMATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    loadPropertyEstimator() {
        this.showScreen('estimatorScreen');
        const iframe  = document.getElementById('property-estimator-frame');
        const loading = document.getElementById('estimatorLoading');

        iframe.onload = () => {
            loading.style.display = 'none';
            iframe.style.display  = 'block';

            const sendData = () => {
                try {
                    iframe.contentWindow.postMessage({ type: 'LOAD_CLAIM_DATA', data: this.currentClaim }, '*');
                } catch (e) { /* cross-origin guard */ }
            };
            sendData();
            setTimeout(sendData, 500);
            setTimeout(sendData, 1000);
            setTimeout(sendData, 2000);
        };

        iframe.onerror = () => {
            loading.innerHTML = `
                <div style="color:#ef4444;font-size:16px;font-weight:bold;">‚ùå Error Loading Property Estimator</div>
                <p style="margin-top:15px;color:#666;">Make sure "Property-Estimator-FIXED.html" is in the same folder.</p>
                <button class="btn btn-primary" onclick="claimManager.showScreen('homeScreen')" style="margin-top:20px;">Return to Home</button>`;
        };

        iframe.src = 'Property-Estimator-FIXED.html';
    }

    // ‚îÄ‚îÄ SAVE CLAIM (FIRESTORE) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async saveClaim(showMessage = true) {
        if (!this.currentClaim) {
            this.showStatus('No claim to save!', 'error');
            return false;
        }

        this.currentClaim.dateModified = this._today();
        sessionStorage.setItem('currentClaim', JSON.stringify(this.currentClaim));

        try {
            // Upsert into Firestore using claimId as document ID
            await db.collection(this.COLLECTION)
                    .doc(this.currentClaim.claimId)
                    .set(this.currentClaim);

            // Keep local cache in sync
            const idx = this.allClaims.findIndex(c => c.claimId === this.currentClaim.claimId);
            if (idx >= 0) this.allClaims[idx] = this.currentClaim;
            else          this.allClaims.push(this.currentClaim);

            if (showMessage) this.showStatus(`‚úÖ Claim "${this.currentClaim.claimName}" saved to Firebase!`, 'success');
            console.log('üî• Saved to Firestore:', this.currentClaim.claimName);
            return true;

        } catch (err) {
            console.error('Firestore save error:', err);
            if (showMessage) this.showStatus('‚ùå Firebase save failed: ' + err.message, 'error');
            return false;
        }
    }

    // ‚îÄ‚îÄ SAVE AS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    showSaveAsScreen() {
        if (!this.currentClaim) { this.showStatus('No claim to save!', 'error'); return; }
        document.getElementById('saveAsName').value          = this.currentClaim.claimName;
        document.getElementById('currentSaveAsName').textContent = this.currentClaim.claimName;
        this.showScreen('saveAsScreen');
    }

    async saveClaimAs() {
        if (!this.currentClaim) { this.showStatus('No claim to save!', 'error'); return; }

        const newName = document.getElementById('saveAsName').value.trim();
        if (!newName) { this.showStatus('Please enter a claim name!', 'error'); return; }

        const oldName = this.currentClaim.claimName;
        if (newName !== oldName) this.currentClaim.claimId = 'CLAIM-' + Date.now();

        this.currentClaim.claimName    = newName;
        this.currentClaim.dateModified = this._today();

        if (await this.saveClaim(false)) {
            this.showStatus(`Claim saved as "${newName}"!`, 'success');
            this.updateCurrentClaimBar();
            this.showScreen('homeScreen');
        }
    }

    // ‚îÄ‚îÄ DELETE CLAIM (FIRESTORE) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async deleteClaim(claimId, event) {
        if (event) event.stopPropagation(); // prevent row click

        const claim = this.allClaims.find(c => c.claimId === claimId);
        if (!claim) return;

        if (!confirm(`Delete "${claim.claimName}"?\n\nThis cannot be undone.`)) return;

        try {
            await db.collection(this.COLLECTION).doc(claimId).delete();
            this.allClaims = this.allClaims.filter(c => c.claimId !== claimId);

            // Clear current claim if we just deleted it
            if (this.currentClaim?.claimId === claimId) {
                this.currentClaim = null;
                sessionStorage.removeItem('currentClaim');
                this.updateCurrentClaimBar();
                document.getElementById('homeSaveBtn').disabled    = true;
                document.getElementById('homeSaveBtn').style.opacity = '0.5';
                document.getElementById('homeSaveAsBtn').disabled  = true;
                document.getElementById('homeSaveAsBtn').style.opacity = '0.5';
            }

            this.showStatus(`üóëÔ∏è Claim "${claim.claimName}" deleted.`, 'success');
            this.displayAllClaims();
        } catch (err) {
            console.error('Firestore delete error:', err);
            this.showStatus('‚ùå Delete failed: ' + err.message, 'error');
        }
    }

    // ‚îÄ‚îÄ IMPORT SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    showImportScreen() {
        document.getElementById('importDataField').value      = '';
        document.getElementById('importPreview').style.display  = 'none';
        document.getElementById('importError').style.display    = 'none';
        document.getElementById('importConfirmBtn').style.display = 'none';
        this.importedData = null;
        this.showScreen('importScreen');
    }

    previewImport() {
        const rawData = document.getElementById('importDataField').value.trim();
        if (!rawData) { this.showImportError('Please paste some data first!'); return; }

        try {
            const parsed = this.parseImportData(rawData);
            if (!parsed) { this.showImportError('Could not detect data format. Please check and try again.'); return; }
            this.importedData = parsed;
            this.showImportPreview(parsed);
            document.getElementById('importConfirmBtn').style.display = 'block';
        } catch (e) {
            this.showImportError('Error parsing data: ' + e.message);
        }
    }

    // ‚îÄ‚îÄ PARSE / NORMALIZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    parseImportData(rawData) {
        // JSON
        if (rawData.trim().startsWith('{') || rawData.trim().startsWith('[')) {
            try { return this.normalizeData(JSON.parse(rawData)); } catch (e) { /* fall through */ }
        }

        const lines = rawData.split('\n').filter(l => l.trim());

        // CSV / Tab with header row
        if (lines.length >= 2 && (lines[0].includes(',') || lines[0].includes('\t'))) {
            const delim   = lines[0].includes('\t') ? '\t' : ',';
            const headers = lines[0].split(delim).map(h => h.trim().toLowerCase());
            const values  = lines[1].split(delim).map(v => v.trim());
            if (headers.length === values.length && headers.length > 0) {
                const data = {};
                headers.forEach((h, i) => { data[h] = values[i]; });
                return this.normalizeData(data);
            }
        }

        // Key: Value
        const kvPattern = /^([^:]+):\s*(.+)$/;
        if (lines.some(l => kvPattern.test(l))) {
            const data = {};
            lines.forEach(l => {
                const m = l.match(kvPattern);
                if (m) data[m[1].trim().toLowerCase().replace(/\s+/g, '')] = m[2].trim();
            });
            if (Object.keys(data).length > 0) return this.normalizeData(data);
        }

        // Tab-separated label ‚Üí value
        if (lines.length > 0 && lines[0].includes('\t')) {
            const data = {};
            lines.forEach(l => {
                const parts = l.split('\t').map(p => p.trim());
                if (parts.length >= 2) data[parts[0].toLowerCase().replace(/\s+/g, '')] = parts[1];
            });
            if (Object.keys(data).length > 0) return this.normalizeData(data);
        }

        return null;
    }

    normalizeData(data) {
        const keyMap = {};
        Object.keys(data).forEach(k => { keyMap[k.toLowerCase().replace(/[^a-z0-9]/g, '')] = data[k]; });

        const find = (...keys) => {
            for (const k of keys) {
                const n = k.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (keyMap[n]) return keyMap[n];
            }
            return '';
        };

        const adjFirst = find('adjusterfirstname', 'adjusterFirst');
        const adjLast  = find('adjusterlastname',  'adjusterLast');

        return {
            clientInfo: {
                firstName:    find('firstName','first','fname','givenname'),
                middleInitial:find('middleInitial','middle','mi'),
                lastName:     find('lastName','last','lname','surname','familyname'),
                phone:        find('phone','phoneNumber','mobile','cell','telephone'),
                email:        find('email','emailAddress','mail'),
                address:      find('streetAddress1','address','street','streetAddress','propertyAddress','address1'),
                city:         find('city','town'),
                state:        find('state','province'),
                zip:          find('zip','zipCode','postalCode','postcode')
            },
            claimInfo: {
                claimNumber:  find('claimNumber','claim','claimNum','claimNo','claimId','insuranceclaimnumber'),
                dateOfLoss:   find('dateOfLoss','lossDate','incidentDate','date'),
                lossType:     find('lossType','type','damageType','incidentType','causeoflossperil','reasonforclaim'),
                description:  find('description','desc','details','notes','descriptionofloss')
            },
            insuranceInfo: {
                company:       find('insuranceCompany','insurancecompanyname','insurance','insurer','carrier','company'),
                policyNumber:  find('policyNumber','policy','policyNum','policyNo'),
                deductible:    find('deductible','deduct','deductable'),
                adjuster:      find('adjuster','adjusterName','agent') ||
                               (adjFirst && adjLast ? `${adjFirst} ${adjLast}` : adjFirst || adjLast || ''),
                adjusterPhone: find('adjusterPhone','adjusterPhoneNumber','agentPhone'),
                adjusterEmail: find('adjusterEmail','adjusterEmailAddress','agentEmail')
            }
        };
    }

    showImportPreview(data) {
        document.getElementById('importError').style.display = 'none';
        let html = '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;">';

        const section = (title, fields) => {
            const rows = fields.filter(([,v]) => v).map(([l,v]) => `<li>${l}: ${v}</li>`).join('');
            if (!rows) return '';
            return `<div><strong>${title}</strong><ul style="margin:5px 0 0 20px;padding:0;">${rows}</ul></div>`;
        };

        if (data.clientInfo) {
            const c = data.clientInfo;
            html += section('üë§ Client Information:', [
                ['First', c.firstName], ['Last', c.lastName], ['Phone', c.phone],
                ['Email', c.email], ['Address', c.address], ['City', c.city],
                ['State', c.state], ['ZIP', c.zip]
            ]);
        }
        if (data.claimInfo) {
            const cl = data.claimInfo;
            html += section('üìã Claim Information:', [
                ['Claim #', cl.claimNumber], ['Date of Loss', cl.dateOfLoss],
                ['Loss Type', cl.lossType],
                ['Description', cl.description ? cl.description.substring(0,50) + (cl.description.length > 50 ? '‚Ä¶' : '') : '']
            ]);
        }
        if (data.insuranceInfo) {
            const ins = data.insuranceInfo;
            html += `<div style="grid-column:1/-1;">` + section('üè¢ Insurance Information:', [
                ['Company', ins.company], ['Policy #', ins.policyNumber], ['Deductible', ins.deductible],
                ['Adjuster', ins.adjuster], ['Adj. Phone', ins.adjusterPhone], ['Adj. Email', ins.adjusterEmail]
            ]).replace('<div>', '').replace('</div>', '') + '</div>';
        }

        html += '</div>';
        document.getElementById('importPreviewContent').innerHTML = html;
        document.getElementById('importPreview').style.display    = 'block';
    }

    showImportError(msg) {
        document.getElementById('importPreview').style.display    = 'none';
        document.getElementById('importConfirmBtn').style.display = 'none';
        document.getElementById('importErrorMessage').textContent = msg;
        document.getElementById('importError').style.display      = 'block';
    }

    async importClaim() {
        if (!this.importedData) { this.showStatus('No data to import!', 'error'); return; }
        this._createClaimFromData(this.importedData);
        await this.saveClaim(false);
        this.showStatus(`üì• Imported claim: ${this.currentClaim.claimName}`, 'success');
        this.showClaimOpenedOptions();
    }

    _createClaimFromData(data) {
        this.currentClaim = {
            claimId:       'CLAIM-' + Date.now(),
            claimName:     'Imported Claim',
            dateCreated:   this._today(),
            dateModified:  this._today(),
            clientInfo:    data.clientInfo    || {},
            claimInfo:     data.claimInfo     || {},
            insuranceInfo: data.insuranceInfo || {},
            propertyData:  null,
            selectedItems: [],
            estimate:      null
        };
        const last  = this.currentClaim.clientInfo.lastName  || 'Unknown';
        const first = this.currentClaim.clientInfo.firstName || 'Unknown';
        const num   = this.currentClaim.claimInfo.claimNumber || '';
        this.currentClaim.claimName = `${last}-${first}${num ? '-' + num : ''}`;

        sessionStorage.setItem('currentClaim', JSON.stringify(this.currentClaim));
        this.updateCurrentClaimBar();
        this.enableSaveButtons();
        this.populateForms();
    }

    // ‚îÄ‚îÄ OPEN SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async showOpenScreen() {
        this.showScreen('openScreen');
        await this.loadAllClaims();
        this.displayAllClaims();
    }

    searchClaims() {
        const last  = document.getElementById('searchLastName').value.trim().toLowerCase();
        const first = document.getElementById('searchFirstName').value.trim().toLowerCase();
        let filtered = this.allClaims;
        if (last)  filtered = filtered.filter(c => c.clientInfo.lastName?.toLowerCase().includes(last));
        if (first) filtered = filtered.filter(c => c.clientInfo.firstName?.toLowerCase().includes(first));
        this.displayClaims(filtered);
    }

    displayAllClaims() { this.displayClaims(this.allClaims); }

    displayClaims(claims) {
        const list = document.getElementById('claimsList');
        if (claims.length === 0) {
            list.innerHTML = '<div class="no-claims">No claims found.</div>';
            return;
        }
        list.innerHTML = claims.map(c => `
            <div class="claim-item">
                <div class="claim-item-info" onclick="claimManager.openClaim('${c.claimId}')">
                    <div class="claim-name">${c.claimName}</div>
                    <div class="claim-details">
                        ${c.clientInfo.firstName || ''} ${c.clientInfo.lastName || ''} |
                        ${c.claimInfo.lossType || 'N/A'} |
                        Claim #${c.claimInfo.claimNumber || 'N/A'}
                    </div>
                    <div class="claim-date">Created: ${c.dateCreated} | Modified: ${c.dateModified}</div>
                </div>
                <div class="claim-item-actions">
                    <button class="btn btn-primary btn-sm" onclick="claimManager.openClaim('${c.claimId}')">üìÇ Open</button>
                    <button class="btn btn-danger btn-sm" onclick="claimManager.deleteClaim('${c.claimId}', event)">üóëÔ∏è</button>
                </div>
            </div>
        `).join('');
    }

    openClaim(claimId) {
        const claim = this.allClaims.find(c => c.claimId === claimId);
        if (!claim) { this.showStatus('Claim not found!', 'error'); return; }

        this.currentClaim = claim;
        sessionStorage.setItem('currentClaim', JSON.stringify(this.currentClaim));
        this.updateCurrentClaimBar();
        this.enableSaveButtons();
        this.populateForms();
        this.showClaimOpenedOptions();
    }

    showClaimOpenedOptions() {
        const c   = this.currentClaim.clientInfo;
        const cl  = this.currentClaim.claimInfo;
        const ins = this.currentClaim.insuranceInfo;

        document.getElementById('openedClientName').textContent  = `${c.firstName || ''} ${c.lastName || ''}`.trim() || 'N/A';
        document.getElementById('openedClaimNumber').textContent = cl.claimNumber || 'N/A';
        document.getElementById('openedLossType').textContent    = cl.lossType    || 'N/A';
        document.getElementById('openedInsurance').textContent   = ins.company    || 'N/A';
        document.getElementById('openedAddress').textContent     =
            `${c.address || ''}, ${c.city || ''}, ${c.state || ''} ${c.zip || ''}`.replace(/,\s*,/g, ',').trim() || 'N/A';

        this.showScreen('claimOpenedScreen');
        this.showStatus(`üìÇ Opened claim: ${this.currentClaim.claimName}`, 'success');
    }

    goToEstimator() { this.loadPropertyEstimator(); }

    populateForms() {
        if (!this.currentClaim) return;
        const fill = (formId, data) => {
            const form = document.getElementById(formId);
            Object.keys(data).forEach(k => {
                const el = form.querySelector(`[name="${k}"]`);
                if (el) el.value = data[k] || '';
            });
        };
        fill('clientForm',    this.currentClaim.clientInfo);
        fill('claimForm',     this.currentClaim.claimInfo);
        fill('insuranceForm', this.currentClaim.insuranceInfo);
    }

    // ‚îÄ‚îÄ LOAD ALL CLAIMS (FIRESTORE) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async loadAllClaims() {
        try {
            const snapshot = await db.collection(this.COLLECTION)
                                     .orderBy('dateModified', 'desc')
                                     .get();
            this.allClaims = snapshot.docs.map(d => d.data());
            return this.allClaims;
        } catch (err) {
            console.warn('Could not load claims from Firestore:', err);
            this.allClaims = [];
            return [];
        }
    }

    // ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    updateCurrentClaimBar() {
        const bar  = document.getElementById('currentClaimBar');
        const name = document.getElementById('currentClaimName');
        const date = document.getElementById('currentClaimDate');
        if (this.currentClaim) {
            bar.classList.add('show');
            name.textContent = this.currentClaim.claimName;
            date.textContent = `Modified: ${this.currentClaim.dateModified}`;
        } else {
            bar.classList.remove('show');
        }
    }

    enableSaveButtons() {
        ['homeSaveBtn','homeSaveAsBtn'].forEach(id => {
            document.getElementById(id).disabled     = false;
            document.getElementById(id).style.opacity = '1';
        });
    }

    returnHome() {
        if (this.currentClaim) this.saveClaim(false);
        this.showScreen('homeScreen');
    }

    showStatus(message, type = 'success') {
        const el = document.getElementById('statusMessage');
        el.textContent = message;
        el.className   = `status-message show ${type}`;
        clearTimeout(this._statusTimer);
        this._statusTimer = setTimeout(() => el.classList.remove('show'), 5000);
    }

    _today() { return new Date().toISOString().split('T')[0]; }
}

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let claimManager;
window.addEventListener('DOMContentLoaded', () => {
    claimManager = new ClaimManager();
});

// Estimator data auto-save
window.addEventListener('message', (event) => {
    if (event.data?.type === 'ESTIMATOR_DATA_UPDATED' && claimManager?.currentClaim) {
        claimManager.currentClaim.propertyData  = event.data.propertyData;
        claimManager.currentClaim.selectedItems = event.data.selectedItems;
        claimManager.currentClaim.estimate      = event.data.estimate;
        claimManager.saveClaim(false);
    }
});
</script>
</body>
</html>
